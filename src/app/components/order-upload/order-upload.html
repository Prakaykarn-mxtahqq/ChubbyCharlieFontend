<div class="upload-container">
  <div class="upload-header">
    <div class="back-button" (click)="goBack()">
      <i class="bi-arrow-left"></i> กลับ
    </div>
    <h1>อัพโหลดออเดอร์</h1>
    <p class="subtitle">อัพโหลด PDF จาก 24Shop หรือ Excel จาก Shopee</p>
  </div>

  <div class="upload-content">
    <!-- Upload Type Selection -->
    <div class="upload-type-section">
      <h3>เลือกประเภทไฟล์</h3>
      <div class="type-options">
        <div class="type-option"
             [class.active]="uploadType === '24shop'"
             (click)="uploadType = '24shop'; removeFile()">
          <i class="bi-file-earmark-pdf"></i>
          <div class="type-info">
            <h4>24Shop</h4>
            <p>อัพโหลดไฟล์ PDF จาก 24Shopping</p>
          </div>
        </div>

        <div class="type-option"
             [class.active]="uploadType === 'shopee'"
             (click)="uploadType = 'shopee'; removeFile()">
          <i class="bi-file-earmark-excel"></i>
          <div class="type-info">
            <h4>Shopee</h4>
            <p>อัพโหลดไฟล์ Excel จาก Shopee</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ข้อมูลออเดอร์ (เฉพาะ 24Shop) -->
    <div class="order-info-section" *ngIf="uploadType === '24shop'">
      <h3>ข้อมูลออเดอร์</h3>

      <div class="order-form-grid">
        <div class="form-group">
          <label class="required">เลขที่ออเดอร์ (PO Number)</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="orderNumber"
            placeholder="เช่น CT37445675"
            required>
          <small class="form-hint">ระบุเลขที่ PO จากเอกสาร</small>
        </div>

        <div class="form-group" style="position: relative;">
          <label class="required">เลือกลูกค้า</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="searchCustomerTerm"
            (input)="onCustomerSearch()"
            (focus)="showCustomerDropdown = true"
            (blur)="hideCustomerDropdown()"
            placeholder="ค้นหาชื่อหรือเบอร์โทร"
            required>
          <small class="form-hint" *ngIf="selectedCustomerId">
            ✓ เลือกลูกค้าแล้ว
          </small>

          <div class="customer-dropdown" *ngIf="showCustomerDropdown && filteredCustomers.length > 0">
            <div
              class="customer-item"
              *ngFor="let customer of filteredCustomers"
              (mousedown)="selectCustomer(customer)">
              <span class="customer-name">{{customer.customerName}}</span>
              <span class="customer-phone" *ngIf="customer.customerPhone">{{customer.customerPhone}}</span>
            </div>
          </div>

          <div class="no-customers" *ngIf="showCustomerDropdown && filteredCustomers.length === 0">
            ไม่พบลูกค้า
          </div>
        </div>
      </div>
    </div>

    <!-- File Upload Area -->
    <div class="file-upload-section">
      <div class="upload-area"
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)"
           [class.has-file]="selectedFile">

        <div class="upload-placeholder" *ngIf="!selectedFile">
          <i class="bi-cloud-upload"></i>
          <h3>ลากไฟล์มาวางที่นี่</h3>
          <p>หรือคลิกเพื่อเลือกไฟล์</p>
          <input type="file"
                 #fileInput
                 (change)="onFileSelected($event)"
                 [accept]="uploadType === '24shop' ? '.pdf' : '.xlsx,.xls'"
                 style="display: none;">
          <button class="browse-btn" (click)="fileInput.click()">
            เลือกไฟล์
          </button>
          <small class="file-hint">
            รองรับไฟล์: {{uploadType === '24shop' ? 'PDF' : 'Excel (XLSX, XLS)'}}
          </small>
        </div>

        <div class="file-info" *ngIf="selectedFile">
          <i [class]="getFileIcon()"></i>
          <div class="file-details">
            <h4>{{selectedFile.name}}</h4>
            <p>{{formatFileSize(selectedFile.size)}}</p>
          </div>
          <button class="remove-file-btn" (click)="removeFile()">
            <i class="bi-x"></i>
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="upload-options" *ngIf="selectedFile">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="autoDeductStock">
          <span>ตัด Stock อัตโนมัติหลังอัพโหลด</span>
          <small>ระบบจะตัด Stock ตามจำนวนสินค้าในออเดอร์ทันที</small>
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="upload-actions" *ngIf="selectedFile">
        <button class="preview-btn"
                (click)="previewFile()"
                [disabled]="uploading">
          <i class="bi-eye"></i>
          ดูตัวอย่าง
        </button>

        <button class="upload-btn"
                (click)="uploadFile()"
                [disabled]="uploading">
          <div class="loading-spinner" *ngIf="uploading"></div>
          <i class="bi-upload" *ngIf="!uploading"></i>
          {{uploading ? 'กำลังอัพโหลด...' : 'อัพโหลด'}}
        </button>
      </div>
    </div>

    <!-- Preview Section สำหรับ 24Shop -->
    <div class="preview-section" *ngIf="previewItems.length > 0 && uploadType === '24shop'">
      <h3>ตัวอย่างรายการสินค้า ({{previewItems.length}} รายการ)</h3>
      <div class="preview-table">
        <table>
          <thead>
          <tr>
            <th>SKU</th>
            <th>ชื่อสินค้า</th>
            <th>จำนวน</th>
            <th>ราคา/หน่วย</th>
            <th>รวม</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let item of previewItems">
            <td>{{item.productSku}}</td>
            <td>{{item.productName}}</td>
            <td>{{item.quantity}}</td>
            <td>{{formatCurrency(item.unitPrice)}}</td>
            <td>{{formatCurrency(item.totalPrice)}}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Preview Section สำหรับ Shopee -->
    <div class="preview-section" *ngIf="previewOrders.length > 0 && uploadType === 'shopee'">
      <h3>ตัวอย่างออเดอร์</h3>
      <div class="preview-cards">
        <div class="preview-card" *ngFor="let order of previewOrders">
          <div class="preview-header">
            <h4>{{order.orderNumber}}</h4>
            <span class="preview-source">{{order.source === 'SHOP_24' ? '24Shop' : 'Shopee'}}</span>
          </div>

          <div class="preview-body">
            <div class="preview-row">
              <span class="label">ลูกค้า:</span>
              <span class="value">{{order.customerName}}</span>
            </div>
            <div class="preview-row" *ngIf="order.customerPhone">
              <span class="label">เบอร์โทร:</span>
              <span class="value">{{order.customerPhone}}</span>
            </div>
            <div class="preview-row" *ngIf="order.shippingAddress">
              <span class="label">ที่อยู่:</span>
              <span class="value">{{order.shippingAddress}}</span>
            </div>
            <div class="preview-row">
              <span class="label">ยอดรวม:</span>
              <span class="value price">{{formatCurrency(order.netAmount)}}</span>
            </div>
          </div>

          <div class="preview-items" *ngIf="order.orderItems && order.orderItems.length > 0">
            <h5>รายการสินค้า ({{order.orderItems.length}} รายการ)</h5>
            <div class="preview-item" *ngFor="let item of order.orderItems">
              <span class="item-name">{{item.productName}}</span>
              <span class="item-qty">x {{item.quantity}}</span>
              <span class="item-price">{{formatCurrency(item.totalPrice)}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Result -->
    <div class="result-section" *ngIf="uploadResult && !uploading">
      <div class="result-card" [class.success]="uploadResult.success" [class.error]="!uploadResult.success">
        <div class="result-icon">
          <i class="bi-check-circle" *ngIf="uploadResult.success"></i>
          <i class="bi-x-circle" *ngIf="!uploadResult.success"></i>
        </div>
        <div class="result-content">
          <h3>{{uploadResult.success ? 'อัพโหลดสำเร็จ' : 'อัพโหลดไม่สำเร็จ'}}</h3>
          <p>{{uploadResult.message}}</p>

          <div class="result-stats" *ngIf="uploadResult.success && uploadType === 'shopee'">
            <div class="stat-item">
              <span class="stat-label">ทั้งหมด:</span>
              <span class="stat-value">{{uploadResult.totalOrders}}</span>
            </div>
            <div class="stat-item success">
              <span class="stat-label">สำเร็จ:</span>
              <span class="stat-value">{{uploadResult.successCount}}</span>
            </div>
            <div class="stat-item error" *ngIf="uploadResult.errorCount > 0">
              <span class="stat-label">ล้มเหลว:</span>
              <span class="stat-value">{{uploadResult.errorCount}}</span>
            </div>
          </div>

          <!-- Stock Deduction Messages -->
          <div class="stock-messages" *ngIf="uploadMessages.length > 0">
            <h4>การตัด Stock:</h4>
            <ul>
              <li *ngFor="let message of uploadMessages"
                  [class.success]="message.startsWith('✓')"
                  [class.error]="message.startsWith('✗')">
                {{message}}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="instructions-section">
      <h3>คำแนะนำ</h3>
      <div class="instruction-cards">
        <div class="instruction-card">
          <div class="instruction-icon">
            <i class="bi-file-earmark-pdf"></i>
          </div>
          <h4>24Shop (PDF)</h4>
          <ul>
            <li>ใช้ไฟล์ PDF จาก Purchase Order ของ 24Shopping</li>
            <li>ระบุเลข PO และเลือกลูกค้าก่อนอัพโหลด</li>
            <li>ระบบจะอ่านข้อมูลสินค้าโดยอัตโนมัติ</li>
          </ul>
        </div>

        <div class="instruction-card">
          <div class="instruction-icon">
            <i class="bi-file-earmark-excel"></i>
          </div>
          <h4>Shopee (Excel)</h4>
          <ul>
            <li>ใช้ไฟล์ Excel ที่ Export จาก Shopee Seller Center</li>
            <li>ควรมี Column: Order Number, Customer Name, Product, Quantity, Price</li>
            <li>รองรับไฟล์ .xlsx และ .xls</li>
          </ul>
        </div>

        <div class="instruction-card">
          <div class="instruction-icon">
            <i class="bi-box-seam"></i>
          </div>
          <h4>การตัด Stock</h4>
          <ul>
            <li>ระบบจะตัด Stock อัตโนมัติจากส่วนประกอบของสินค้า</li>
            <li>ต้องมี Product ที่ตรงกับ SKU ในระบบ</li>
            <li>สามารถตัด Stock ทีหลังได้จากหน้ารายการออเดอร์</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
